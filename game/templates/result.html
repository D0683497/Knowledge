{% extends "layout.html" %}
{% load static %}

{% block title %}知識王 - 結算{% endblock %}

{% block head %}
<!-- development version, includes helpful console warnings -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.1/qs.min.js"></script>

<link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
{% endblock %}

{% block content %}
<div class="container" id="app">
    <!-- Loading -->
    <b-card
        header="讀取結果中"
        header-tag="header"
        align="center"
        border-variant="dark"
        v-if="isLoading"
    >
        <b-card-text>
            <b-spinner style="width: 3rem; height: 3rem;" type="grow" variant="info" label="Large Spinner"></b-spinner>
            <b-spinner style="width: 3rem; height: 3rem;" type="grow" variant="info" label="Large Spinner"></b-spinner>
            <b-spinner style="width: 3rem; height: 3rem;" type="grow" variant="info" label="Large Spinner"></b-spinner>
        </b-card-text>
    </b-card>
    <div v-if="!isLoading">
        <div class="d-flex justify-content-between">
            <h3>成績結算</h3>
            <a class="btn btn-primary" href="{% url 'game' %}" role="button">在玩一次</a>
        </div>
        <hr>
        <b-card
            header-tag="header"
            footer-tag="footer"
            no-body
        >
            <template v-slot:header>
                <div class="d-flex justify-content-between">
                    <span>分數: [[ score ]]</span>
                    <span>挑戰時間: [[ time ]]</span>
                </div>
            </template>
            
            <div class="card border-dark m-1">
                <div class="card-header border-dark bg-transparent">[[ topic ]]</div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li 
                            class="list-group-item" 
                            :class="{ 'list-group-item-success' : option_1==correct_option, 'list-group-item-info' : option_1==select_option }"
                        >
                            [[ option_1 ]]
                        </li>
                        <li 
                            class="list-group-item" 
                            :class="{ 'list-group-item-success' : option_2==correct_option, 'list-group-item-info' : option_2==select_option }"
                        >
                            [[ option_2 ]]
                        </li>
                        <li 
                            class="list-group-item" 
                            :class="{ 'list-group-item-success' : option_3==correct_option, 'list-group-item-info' : option_3==select_option }"
                        >
                            [[ option_3 ]]
                        </li>
                        <li 
                            class="list-group-item" 
                            :class="{ 'list-group-item-success' : option_4==correct_option, 'list-group-item-info' : option_4==select_option }"
                        >
                            [[ option_4 ]]
                        </li>
                    </ul>
                </div>
                <div class="card-footer border-dark bg-transparent d-flex justify-content-between">
                    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#solutionModal">詳解</button>
                    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#reportModal">回報問題</button>
                </div>
            </div>

            <template v-slot:footer>
                <!-- 頁數 -->
                <b-pagination
                    v-model="currentPage"
                    :per-page="perPage"
                    :total-rows="rows"
                    align="fill"
                    class="m-0"
                ></b-pagination>
            </template>
        </b-card>
    </div>
    <!-- 詳解 -->
    <div class="modal fade" id="solutionModal" tabindex="-1" role="dialog" aria-labelledby="solutionModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalCenterTitle">詳解</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                [[ solution ]]
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" data-toggle="modal" data-dismiss="modal" data-target="#reportModal">回報問題</button>
            </div>
          </div>
        </div>
    </div>

    <!-- 回報問題 -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">問題回報</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="description">問題描述</label>
                    <input id="description" name="description" v-model="description" type="text" maxlength="200" autofocus required class="form-control"></input>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" @click="send_report()" data-dismiss="modal">送出</button>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            isLoading: true,
            perPage: 1,
            currentPage: 1,
            score: 0,
            time: '',
            question: [],
            description: '',
        },
        created: function () {
            get_result();

            let self = this;
            function get_result () {
                axios.get('{% url "get_result" %}')
                .then((response) => {
                    if (response.data.message == '挑戰成功') {
                        self.score = response.data.score;
                        var t = new Date(response.data.time);
                        self.time = (t.getMonth()+1) + '/' + t.getDate() + ' ' + t.getHours() + ':' + t.getMinutes(); //getMonth從0開始，要加1
                        self.question = response.data.question;
                        self.isLoading = false;
                    } 
                });
            }
        },
        methods: {
            send_report: function () {
                let self = this;
                axios({
                    method: 'post',
                    url: '{% url "report" %}',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: Qs.stringify({
                        topic: self.topic,
                        description: self.description
                    })
                })
                .then((response) => {
                    if (response.data.message == 'success') {
                        self.$bvToast.toast("感謝您的回報，我們會盡快審查您的疑問", {
                            title: '已收到您的問題',
                            variant: 'success',
                            autoHideDelay: 5000,
                        });
                        self.description = "";
                    } else if (response.data.message == 'fail') {
                        self.$bvToast.toast("您是否有欄位尚未填寫?", {
                            title: '發送失敗',
                            variant: 'danger',
                            autoHideDelay: 5000,
                        });
                        self.description = "";
                    }
                });
            }
        },
        computed: {
            rows() {
                return this.question.length
            },
            topic() {
                return this.question[this.currentPage-1].topic
            },
            option_1() {
                return this.question[this.currentPage-1].option_1
            },
            option_2() {
                return this.question[this.currentPage-1].option_2
            },
            option_3() {
                return this.question[this.currentPage-1].option_3
            },
            option_4() {
                return this.question[this.currentPage-1].option_4
            },
            correct_option() {
                return this.question[this.currentPage-1].correct_option
            },
            select_option() {
                return this.question[this.currentPage-1].select_option
            },
            solution() {
                return this.question[this.currentPage-1].solution
            }
        }
    });
</script>
{% endblock %}
