{% extends "layout.html" %}
{% load static %}

{% block title %}知識王{% endblock %}

{% block head %}
<!-- development version, includes helpful console warnings -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.1/qs.min.js"></script>
{% endblock %}

{% block content %}
<div class="container" id="app">
    <div class="progress" id="progress">
        <div id="time" class="progress-bar progress-bar-striped bg-danger progress-bar-animated" role="progressbar" :style="{width: countDown*10+'%'}" aria-valuemin="0" aria-valuemax="100">
            還剩 [[ countDown ]] 秒
        </div>
    </div>
    <hr>
    <div class="alert alert-secondary" role="alert">
        [[ topic ]]
    </div>
    <hr>
    <div v-for="(option, index) in options">
        <button @click="send_answer(option)" :class="{'my-4': index!=0}" type="button" class="btn btn-primary btn-lg btn-block">
            [[ option ]]
        </button>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    var app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            topic: '',
            options: [],
            countDown : 10,
        },
        created: function () {
            get_question();

            let self = this;
            function get_question () {
                axios.get('{% url "question" %}')
                .then((response) => {
                    self.topic = response.data.topic;
                    self.options.push(response.data.option0);
                    self.options.push(response.data.option1);
                    self.options.push(response.data.option2);
                    self.options.push(response.data.option3);
                });
            }

            self.countDownTimer();
        },
        methods: {
            send_answer: function (option) {
                axios({
                    method: 'post',
                    url: '{% url "answer" %}',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: Qs.stringify({
                        option: option
                    })
                })
                .then((response) => {
                    if (response.data.message == 'success') {
                        let self = this;
                        axios.get('{% url "question" %}')
                        .then((response) => {
                            if (response.data.message == 'success') {
                                self.topic = '';
                                self.options = []
                                self.topic = response.data.topic;
                                self.options.push(response.data.option0);
                                self.options.push(response.data.option1);
                                self.options.push(response.data.option2);
                                self.options.push(response.data.option3);
                                self.countDown = 10;
                            }
                            else if (response.data.message == 'result') {
                                window.location = '{% url "result" %}';
                            }
                        });
                    }
                });
            },
            countDownTimer() {
                if(this.countDown > 0) {
                    setTimeout(() => {
                        this.countDown -= 1
                        this.countDownTimer()
                    }, 1000)
                } else {
                    window.location = '{% url "result" %}';
                }
            }

        }
    });
</script>
{% endblock %}
